# PRD: livekit-svelte

## Project Goal

Build Svelte replacement for `@livekit/components-react` with **100% API parity**

## Folder Structure

```
src/
├── assets/
│   ├── icons/
│   └── images/
├── components/
│   ├── controls/
│   ├── layout/
│   ├── participant/
│   │   ├── animationSequences/
│   │   └── animators/
│   └── index.ts
├── context/
│   └── index.ts
├── hooks/
│   ├── cloud/
│   │   └── krisp/
│   ├── internal/
│   └── index.ts
├── prefabs/
│   └── index.ts
├── index.ts
├── mergeProps.ts
└── utils.ts
```

## Dependencies

### Required Packages

```json
{
	"dependencies": {
		"@livekit/components-core": "workspace:*",
		"clsx": "^2.1.1",
		"events": "^3.3.0",
		"jose": "^6.0.12",
		"livekit-client": "catalog:"
	},
	"peerDependencies": {
		"@livekit/krisp-noise-filter": "^0.2.12 || ^0.3.0",
		"tslib": "^2.6.2"
	},
	"devDependencies": {
		"@livekit/protocol": "catalog:",
		"@sveltejs/kit": "^2.x",
		"@sveltejs/vite-plugin-svelte": "^4.x",
		"svelte": "^5.x",
		"typescript": "^5.x",
		"vite": "^6.x"
	}
}
```

### Optional Dependencies

```json
{
	"optionalPeerDependencies": {
		"@livekit/krisp-noise-filter": "^0.2.12 || ^0.3.0"
	}
}
```

## Testing & Validation Commands

```bash
bun check      # TypeScript type checking
bun lint       # ESLint
bun format     # Prettier
bunx @sveltejs/mcp svelte-autofixer <file.svelte>  # Validate Svelte components
```

## Hooks List

### Core Room Hooks

| Name                 | Purpose                                        | Params                        | Return                                                         | Reference                                                 |
| -------------------- | ---------------------------------------------- | ----------------------------- | -------------------------------------------------------------- | --------------------------------------------------------- |
| `useLiveKitRoom`     | Implements LiveKitRoom component functionality | `props: LiveKitRoomProps`     | `{ room: Room \| undefined; htmlProps: HTMLAttributes<T> }`    | `./reference-only/react/src/hooks/useLiveKitRoom.ts`      |
| `useRoomInfo`        | Get room name and metadata                     | `options: UseRoomInfoOptions` | `{ name: string \| undefined; metadata: string \| undefined }` | `./reference-only/react/src/hooks/useRoomInfo.ts`         |
| `useConnectionState` | Get connection state of the room               | `room?: Room`                 | `ConnectionState`                                              | `./reference-only/react/src/hooks/useConnectionStatus.ts` |

### Participant Hooks

| Name                             | Purpose                                           | Params                                                                                        | Return                                                                                                                                                                                                                                                                      | Reference                                                            |
| -------------------------------- | ------------------------------------------------- | --------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------- |
| `useLocalParticipant`            | Get local participant state and track information | `options: UseLocalParticipantOptions`                                                         | `{ isMicrophoneEnabled: boolean; isCameraEnabled: boolean; isScreenShareEnabled: boolean; microphoneTrack: TrackPublication \| undefined; cameraTrack: TrackPublication \| undefined; lastMicrophoneError: any; lastCameraError: any; localParticipant: LocalParticipant }` | `./reference-only/react/src/hooks/useLocalParticipant.ts`            |
| `useParticipants`                | Get all participants (local and remote)           | `options: UseParticipantsOptions`                                                             | `Participant[]`                                                                                                                                                                                                                                                             | `./reference-only/react/src/hooks/useParticipants.ts`                |
| `useRemoteParticipants`          | Get remote participants only                      | `options: UseRemoteParticipantsOptions`                                                       | `RemoteParticipant[]`                                                                                                                                                                                                                                                       | `./reference-only/react/src/hooks/useRemoteParticipants.ts`          |
| `useRemoteParticipant`           | Get first remote participant by identity or kind  | `identityOrIdentifier: string \| ParticipantIdentifier; options: UseRemoteParticipantOptions` | `RemoteParticipant \| undefined`                                                                                                                                                                                                                                            | `./reference-only/react/src/hooks/useRemoteParticipant.ts`           |
| `useParticipantInfo`             | Get participant identity, name, and metadata      | `props: UseParticipantInfoOptions`                                                            | `{ identity: string \| undefined; name: string \| undefined; metadata: string \| undefined }`                                                                                                                                                                               | `./reference-only/react/src/hooks/useParticipantInfo.ts`             |
| `useParticipantPermissions`      | Get participant permissions                       | `options: UseParticipantPermissionsOptions`                                                   | `ParticipantPermission \| undefined`                                                                                                                                                                                                                                        | `./reference-only/react/src/hooks/useParticipantPermissions.ts`      |
| `useParticipantAttributes`       | Get participant attributes                        | `props: UseParticipantAttributesOptions`                                                      | `{ attributes: Participant['attributes'] }`                                                                                                                                                                                                                                 | `./reference-only/react/src/hooks/useParticipantAttributes.ts`       |
| `useLocalParticipantPermissions` | Get local participant permissions                 | none                                                                                          | `ParticipantPermission \| undefined`                                                                                                                                                                                                                                        | `./reference-only/react/src/hooks/useLocalParticipantPermissions.ts` |
| `useSortedParticipants`          | Get participants sorted by importance             | `participants: Array<Participant>`                                                            | `Participant[]`                                                                                                                                                                                                                                                             | `./reference-only/react/src/hooks/useSortedParticipants.ts`          |
| `useSpeakingParticipants`        | Get active speakers                               | `options: UseSpeakingParticipantsOptions`                                                     | `RemoteParticipant[]`                                                                                                                                                                                                                                                       | `./reference-only/react/src/hooks/useSpeakingParticipants.ts`        |
| `useIsSpeaking`                  | Check if participant is speaking                  | `participant: Participant \| undefined`                                                       | `boolean`                                                                                                                                                                                                                                                                   | `./reference-only/react/src/hooks/useIsSpeaking.ts`                  |

### Track Hooks

| Name                     | Purpose                                    | Params                                                                                                                                                                                                                                                                        | Return                                                                                                                                                                  | Reference                                                    |
| ------------------------ | ------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------ |
| `useTracks`              | Get track references for specified sources | `sources: T; options: UseTracksOptions`                                                                                                                                                                                                                                       | `UseTracksHookReturnType<T>`                                                                                                                                            | `./reference-only/react/src/hooks/useTracks.ts`              |
| `useTrackByName`         | Get a specific track by name               | `name: string; participant: Participant \| undefined`                                                                                                                                                                                                                         | `TrackReferenceOrPlaceholder`                                                                                                                                           | `./reference-only/react/src/hooks/useTrackByName.ts`         |
| `useTrackVolume`         | Get volume level of an audio track         | `trackOrTrackReference: LocalAudioTrack \| RemoteAudioTrack \| TrackReference \| undefined; options: AudioAnalyserOptions`                                                                                                                                                    | `number` (0-1)                                                                                                                                                          | `./reference-only/react/src/hooks/useTrackVolume.ts`         |
| `useParticipantTracks`   | Get tracks of a specific participant only  | `sources: Array<TrackSource>; optionsOrParticipantIdentity: UseParticipantTracksOptions \| string`                                                                                                                                                                            | `Array<TrackReference>`                                                                                                                                                 | `./reference-only/react/src/hooks/useParticipantTracks.ts`   |
| `useTrackMutedIndicator` | Get muted state of a track                 | `trackRef: TrackReferenceOrPlaceholder \| undefined`                                                                                                                                                                                                                          | `{ isMuted: boolean; className: string }`                                                                                                                               | `./reference-only/react/src/hooks/useTrackMutedIndicator.ts` |
| `useIsMuted`             | Check if tracks are muted                  | `trackRef: TrackReferenceOrPlaceholder; options: UseIsMutedOptions`                                                                                                                                                                                                           | `boolean`                                                                                                                                                               | `./reference-only/react/src/hooks/useIsMuted.ts`             |
| `useTrackTranscription`  | Get transcription segments for a track     | `trackRef: TrackReferenceOrPlaceholder \| undefined; options: TrackTranscriptionOptions`                                                                                                                                                                                      | `{ segments: Array<ReceivedTranscriptionSegment> }`                                                                                                                     | `./reference-only/react/src/hooks/useTrackTranscription.ts`  |
| `useTrackToggle`         | Toggle track publication/subscription      | `source: T; onChange?: (enabled: boolean, userInteraction: boolean) => void; initialState?: boolean; captureOptions?: TrackCaptureOptions \| undefined; publishOptions?: TrackPublishOptions \| undefined; onDeviceError?: (e: Error) \| undefined; room?: Room \| undefined` | `{ toggle: () => Promise<void>; enabled: boolean; pending: boolean; track: TrackPublication \| undefined; buttonProps: React.ButtonHTMLAttributes<HTMLButtonElement> }` | `./reference-only/react/src/hooks/useTrackToggle.ts`         |

### Media Device Hooks

| Name                   | Purpose                                                | Params                                                                                                                                                                           | Return                                                                                                                        | Reference                                                  |
| ---------------------- | ------------------------------------------------------ | -------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- |
| `useMediaDevices`      | Get list of media devices of a specific kind           | `kind: MediaDeviceKind; onError?: (e: Error) => void`                                                                                                                            | `MediaDeviceInfo[]`                                                                                                           | `./reference-only/react/src/hooks/useMediaDevices.ts`      |
| `useMediaDeviceSelect` | Handle media device selection and management           | `kind: MediaDeviceKind; room: Room \| undefined; track: LocalAudioTrack \| LocalVideoTrack \| undefined; requestPermissions: boolean \| undefined; onError?: (e: Error) => void` | `{ devices: MediaDeviceInfo[]; className: string; activeDeviceId: string; setActiveMediaDevice: (deviceId: string) => void }` | `./reference-only/react/src/hooks/useMediaDeviceSelect.ts` |
| `useFacingMode`        | Determine facing mode of local participant video track | `trackReference: TrackReferenceOrPlaceholder`                                                                                                                                    | `'user' \| 'environment' \| 'left' \| 'right' \| 'undefined'`                                                                 | `./reference-only/react/src/hooks/useFacingMode.ts`        |

### State and Status Hooks

| Name                            | Purpose                                | Params                                                                  | Return                                              | Reference                                                           |
| ------------------------------- | -------------------------------------- | ----------------------------------------------------------------------- | --------------------------------------------------- | ------------------------------------------------------------------- |
| `useIsEncrypted`                | Check if room is encrypted             | `participant: Participant \| undefined; options: UseIsEncryptedOptions` | `boolean`                                           | `./reference-only/react/src/hooks/useIsEncrypted.ts`                |
| `useIsRecording`                | Check if room is being recorded        | `room: Room \| undefined`                                               | `boolean`                                           | `./reference-only/react/src/hooks/useIsRecording.ts`                |
| `useConnectionQualityIndicator` | Get connection quality indicator props | `options: ConnectionQualityIndicatorOptions`                            | `{ className: string; quality: ConnectionQuality }` | `./reference-only/react/src/hooks/useConnectionQualityIndicator.ts` |

### Chat and Communication Hooks

| Name                | Purpose                                                      | Params                                                                    | Return                                                                                                                                        | Reference                                               |
| ------------------- | ------------------------------------------------------------ | ------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------- |
| `useChat`           | Handle chat functionality in a room                          | `options: (ChatOptions & { room?: Room }) \| undefined`                   | `{ chatMessages: ReceivedChatMessage[]; send: (message: string, options?: ChatOptions) => Promise<ReceivedChatMessage>; isSending: boolean }` | `./reference-only/react/src/hooks/useChat.ts`           |
| `useDataChannel`    | Handle data channel communication                            | `topic: T; onMessage: (msg: ReceivedDataMessage<T>) => void \| undefined` | `UseDataChannelReturnType<T>`                                                                                                                 | `./reference-only/react/src/hooks/useDataChannel.ts`    |
| `useTextStream`     | Get text streams from a specific topic                       | `topic: string; options: UseTextStreamOptions`                            | `{ textStreams: TextStreamData[] }`                                                                                                           | `./reference-only/react/src/hooks/useTextStream.ts`     |
| `useTranscriptions` | Get transcriptions for participant identities and track sids | `opts: UseTranscriptionsOptions`                                          | `Array<TextStreamData>`                                                                                                                       | `./reference-only/react/src/hooks/useTranscriptions.ts` |

### AI Agent Hooks

| Name                                 | Purpose                                                    | Params                                                                                                                       | Return                                         | Reference                                                                |
| ------------------------------------ | ---------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------- | ------------------------------------------------------------------------ |
| `useAgent`                           | Manage AI agent state and lifecycle                        | `session: SessionStub`                                                                                                       | `UseAgentReturn`                               | `./reference-only/react/src/hooks/useAgent.ts`                           |
| `useVoiceAssistant`                  | Find first agent-participant in the room                   | none                                                                                                                         | `VoiceAssistant`                               | `./reference-only/react/src/hooks/useVoiceAssistant.ts`                  |
| `useSession`                         | Managed connection to a Room which can contain Agents      | `tokenSource: TokenSourceConfigurable \| TokenSourceFixed; options: UseSessionConfigurableOptions \| UseSessionFixedOptions` | `UseSessionReturn`                             | `./reference-only/react/src/hooks/useSession.ts`                         |
| `useSessionMessages`                 | Manage messages from chat and transcriptions in a session  | `session: UseSessionReturn`                                                                                                  | `UseSessionMessagesReturn`                     | `./reference-only/react/src/hooks/useSessionMessages.ts`                 |
| `useSequentialRoomConnectDisconnect` | Sequentialize room connection and disconnection operations | `room: Room \| undefined`                                                                                                    | `UseSequentialRoomConnectDisconnectResults<R>` | `./reference-only/react/src/hooks/useSequentialRoomConnectDisconnect.ts` |

### Layout and UI Hooks

| Name                    | Purpose                                                           | Params                                                                                                                | Return                                                                                                                                                                                                              | Reference                                                   |
| ----------------------- | ----------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------- |
| `useGridLayout`         | Handle grid layout for participants                               | `gridElement: React.RefObject<HTMLDivElement>; trackCount: number; options: { gridLayouts?: GridLayoutDefinition[] }` | `{ layout: GridLayoutInfo; containerWidth: number; containerHeight: number }`                                                                                                                                       | `./reference-only/react/src/hooks/useGridLayout.ts`         |
| `usePagination`         | Implement pagination logic for arrays                             | `itemPerPage: number; trackReferences: TrackReferenceOrPlaceholder[]`                                                 | `{ totalPageCount: number; nextPage: () => void; prevPage: () => void; setPage: (num: number) => void; firstItemIndex: number; lastItemIndex: number; tracks: TrackReferenceOrPlaceholder[]; currentPage: number }` | `./reference-only/react/src/hooks/usePagination.ts`         |
| `useVisualStableUpdate` | Prevent visually jarring jumps and shifts of elements in an array | `trackReferences: TrackReferenceOrPlaceholder[]; maxItemsOnPage: number; options: UseVisualStableUpdateOptions`       | `TrackReferenceOrPlaceholder[]`                                                                                                                                                                                     | `./reference-only/react/src/hooks/useVisualStableUpdate.ts` |
| `useFocusToggle`        | Handle participant focus functionality                            | `props: UseFocusToggleProps`                                                                                          | `{ mergedProps: React.ButtonHTMLAttributes<HTMLButtonElement>; inFocus: boolean }`                                                                                                                                  | `./reference-only/react/src/hooks/useFocusToggle.ts`        |
| `usePinnedTracks`       | Get pinned tracks of the current room                             | `layoutContext: LayoutContextType \| undefined`                                                                       | `TrackReferenceOrPlaceholder[]`                                                                                                                                                                                     | `./reference-only/react/src/hooks/usePinnedTracks.ts`       |
| `useSwipe`              | Detect horizontal swipe actions on touch devices                  | `element: React.RefObject<HTMLElement>; options: UseSwipeOptions`                                                     | `void`                                                                                                                                                                                                              | `./reference-only/react/src/hooks/useSwipe.ts`              |

### Component Hooks (for implementing components)

| Name                  | Purpose                                                  | Params                                                                                                                                                                                                            | Return                                                                                  | Reference                                                 |
| --------------------- | -------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------- | --------------------------------------------------------- |
| `useParticipantTile`  | Provide props for implementing ParticipantTile component | `trackRef: TrackReferenceOrPlaceholder \| undefined; onParticipantClick: (event: ParticipantClickEvent) => void \| undefined; disableSpeakingIndicator: boolean \| undefined; htmlProps: React.HTMLAttributes<T>` | `{ elementProps: React.HTMLAttributes<T> }`                                             | `./reference-only/react/src/hooks/useParticipantTile.ts`  |
| `useDisconnectButton` | Provide props for implementing disconnect button         | `props: DisconnectButtonProps`                                                                                                                                                                                    | `{ buttonProps: DisconnectButtonProps }`                                                | `./reference-only/react/src/hooks/useDisconnectButton.ts` |
| `useClearPinButton`   | Provide props for implementing clear pin button          | `props: ClearPinButtonProps`                                                                                                                                                                                      | `{ buttonProps: ClearPinButtonProps }`                                                  | `./reference-only/react/src/hooks/useClearPinButton.ts`   |
| `useChatToggle`       | Provide state and functions for toggling chat window     | `props: UseChatToggleProps`                                                                                                                                                                                       | `{ mergedProps: React.ButtonHTMLAttributes<HTMLButtonElement> }`                        | `./reference-only/react/src/hooks/useChatToggle.ts`       |
| `useStartAudio`       | Manage audio playback permissions                        | `room: Room \| undefined; props: React.ButtonHTMLAttributes<HTMLButtonElement>`                                                                                                                                   | `{ mergedProps: React.ButtonHTMLAttributes<HTMLButtonElement>; canPlayAudio: boolean }` | `./reference-only/react/src/hooks/useStartAudio.ts`       |
| `useStartVideo`       | Manage video playback permissions                        | `room: Room \| undefined; props: React.ButtonHTMLAttributes<HTMLButtonElement>`                                                                                                                                   | `{ mergedProps: React.ButtonHTMLAttributes<HTMLButtonElement>; canPlayVideo: boolean }` | `./reference-only/react/src/hooks/useStartVideo.ts`       |
| `useAudioPlayback`    | Manage audio playback permissions                        | `room: Room \| undefined`                                                                                                                                                                                         | `{ canPlayAudio: boolean; startAudio: () => Promise<void> }`                            | `./reference-only/react/src/hooks/useAudioPlayback.ts`    |

### Utility Hooks

| Name                        | Purpose                                            | Params                                                                                                                                                             | Return                                                                                                                                                                                                                                                                                          | Reference                                                       |
| --------------------------- | -------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| `useToken`                  | Fetch token from token endpoint                    | `tokenEndpoint: string \| undefined; roomName: string; options: UseTokenOptions`                                                                                   | `string \| undefined`                                                                                                                                                                                                                                                                           | `./reference-only/react/src/hooks/useToken.ts`                  |
| `usePersistentUserChoices`  | Access user choices stored in local storage        | `options: UsePersistentUserChoicesOptions`                                                                                                                         | `{ userChoices: LocalUserChoices; saveAudioInputEnabled: (isEnabled: boolean) => void; saveVideoInputEnabled: (isEnabled: boolean) => void; saveAudioInputDeviceId: (deviceId: string) => void; saveVideoInputDeviceId: (deviceId: string) => void; saveUsername: (username: string) => void }` | `./reference-only/react/src/hooks/usePersistentUserChoices.ts`  |
| `useWarnAboutMissingStyles` | Warn about missing LiveKit styles                  | `el?: HTMLElement`                                                                                                                                                 | `void`                                                                                                                                                                                                                                                                                          | `./reference-only/react/src/hooks/useWarnAboutMissingStyles.ts` |
| `useEvents`                 | Manage event subscription for typed event emitters | `instance: Emitter \| { internal: { emitter: Emitter } } \| null \| undefined; event: Event; handlerFn: Callback \| undefined; dependencies: React.DependencyList` | `void`                                                                                                                                                                                                                                                                                          | `./reference-only/react/src/hooks/useEvents.ts`                 |

### Internal Hooks

| Name                 | Purpose                                   | Params                                                                                       | Return           | Reference                                                         |
| -------------------- | ----------------------------------------- | -------------------------------------------------------------------------------------------- | ---------------- | ----------------------------------------------------------------- |
| `useObservableState` | Subscribe to observables and update state | `observable: Observable<T> \| undefined; startWith: T; resetWhenObservableChanges?: boolean` | `T`              | `./reference-only/react/src/hooks/internal/useObservableState.ts` |
| `useMediaQuery`      | Monitor CSS media query matches           | `query: string`                                                                              | `boolean`        | `./reference-only/react/src/hooks/internal/useMediaQuery.ts`      |
| `useResizeObserver`  | Monitor element size changes              | `target: React.RefObject<T>; callback: UseResizeObserverCallback`                            | `ResizeObserver` | `./reference-only/react/src/hooks/internal/useResizeObserver.ts`  |

### Cloud Hooks

| Name                  | Purpose                                    | Params                                | Return | Reference                                                             |
| --------------------- | ------------------------------------------ | ------------------------------------- | ------ | --------------------------------------------------------------------- |
| `useKrispNoiseFilter` | Apply Krisp noise filtering to audio track | `track: LocalAudioTrack \| undefined` | `void` | `./reference-only/react/src/hooks/cloud/krisp/useKrispNoiseFilter.ts` |

## Components List

### Core Room Components

| Name                | Purpose                                                         | Props                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 | Output/Behavior                                                                                                  | Reference                                                     |
| ------------------- | --------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------- |
| `LiveKitRoom`       | Root component providing room context to children               | `serverUrl: string \| undefined; token: string \| undefined; audio?: AudioCaptureOptions \| boolean; video?: VideoCaptureOptions \| boolean; screen?: ScreenShareCaptureOptions \| boolean; connect?: boolean; options?: RoomOptions; connectOptions?: RoomConnectOptions; onConnected?: () => void; onDisconnected?: (reason?: DisconnectReason) => void; onError?: (error: Error) => void; onMediaDeviceFailure?: (failure?: MediaDeviceFailure, kind?: MediaDeviceKind) => void; onEncryptionError?: (error: Error) => void; room?: Room; simulateParticipants?: number \| undefined; featureFlags?: FeatureFlags` | Provides RoomContext and LKFeatureContext, manages LiveKit room connection                                       | `./reference-only/react/src/components/LiveKitRoom.tsx`       |
| `SessionProvider`   | Provides session context and room context to children           | `session: UseSessionReturn; children: React.ReactNode`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                | Provides SessionContext and RoomContext to child components                                                      | `./reference-only/react/src/components/SessionProvider.tsx`   |
| `ConnectionState`   | Display connection status of the LiveKit room                   | `room?: Room`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                         | Renders div containing connection state string ('connected' \| 'connecting' \| 'disconnected' \| 'reconnecting') | `./reference-only/react/src/components/ConnectionState.tsx`   |
| `RoomAudioRenderer` | Drop-in solution for handling remote participants' audio tracks | `room?: Room; volume?: number; muted?: boolean`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                       | Renders hidden divs with AudioTrack components for microphone, screen share audio, and unknown audio tracks      | `./reference-only/react/src/components/RoomAudioRenderer.tsx` |
| `RoomName`          | Render the name of the connected LiveKit room                   | `childrenPosition?: 'before' \| 'after'`                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                              | Renders span containing room name with optional children before/after                                            | `./reference-only/react/src/components/RoomName.tsx`          |

### Layout Components

| Name                    | Purpose                                                             | Props                                                                                                               | Output/Behavior                                                                                          | Reference                                                                |
| ----------------------- | ------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| `ParticipantLoop`       | Loop over participants to create context for each                   | `participants: Participant[]; children: React.ReactNode`                                                            | Creates ParticipantContext.Provider for each participant and renders child component within each context | `./reference-only/react/src/components/ParticipantLoop.tsx`              |
| `TrackLoop`             | Loop over tracks to create context for each                         | `tracks: TrackReference[] \| TrackReferenceOrPlaceholder[]; children: React.ReactNode`                              | Creates TrackRefContext.Provider for each track and renders child component within each context          | `./reference-only/react/src/components/TrackLoop.tsx`                    |
| `GridLayout`            | Grid layout for participants with pagination support                | `children: React.ReactNode; tracks: TrackReferenceOrPlaceholder[]; updateOnlyOn?: RoomEvent[]`                      | Renders grid of participants with pagination controls when overflow occurs                               | `./reference-only/react/src/components/layout/GridLayout.tsx`            |
| `FocusLayout`           | Layout for displaying a single focused participant                  | `trackRef?: TrackReferenceOrPlaceholder; onParticipantClick?: (evt: ParticipantClickEvent) => void`                 | Renders ParticipantTile for a single focused participant                                                 | `./reference-only/react/src/components/layout/FocusLayout.tsx`           |
| `FocusLayoutContainer`  | Container component for focus layout with side component            | none                                                                                                                | Renders div with 'lk-focus-layout' class containing children                                             | `./reference-only/react/src/components/layout/FocusLayoutContainer.tsx`  |
| `CarouselLayout`        | Display tracks in a scrollable container with automatic orientation | `tracks: TrackReferenceOrPlaceholder[]; children: React.ReactNode; orientation?: 'vertical' \| 'horizontal'`        | Renders scrollable container with TrackLoop that displays as many tiles as fit                           | `./reference-only/react/src/components/layout/CarouselLayout.tsx`        |
| `LayoutContextProvider` | Provide layout context for managing pin and widget states           | `value?: LayoutContextType; onPinChange?: (state: PinState) => void; onWidgetChange?: (state: WidgetState) => void` | Provides LayoutContext and handles pin/widget state changes                                              | `./reference-only/react/src/components/layout/LayoutContextProvider.tsx` |

### Participant Components

| Name                         | Purpose                                                                      | Props                                                                                                                                                                                       | Output/Behavior                                                                                              | Reference                                                                          |
| ---------------------------- | ---------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------- |
| `ParticipantTile`            | Base wrapper for displaying visual representation of participants            | `trackRef?: TrackReferenceOrPlaceholder; disableSpeakingIndicator?: boolean; onParticipantClick?: (event: ParticipantClickEvent) => void`                                                   | Renders VideoTrack/AudioTrack, participant metadata, placeholders, and focus toggle                          | `./reference-only/react/src/components/participant/ParticipantTile.tsx`            |
| `ParticipantAudioTile`       | Base utility wrapper for displaying participant audio with visual indicators | `trackRef?: TrackReferenceOrPlaceholder; disableSpeakingIndicator?: boolean; onParticipantClick?: (event: ParticipantClickEvent) => void`                                                   | Renders AudioTrack, BarVisualizer, track muted indicator, participant name, and connection quality indicator | `./reference-only/react/src/components/participant/ParticipantAudioTile.tsx`       |
| `ParticipantName`            | Display participant name or identity                                         | `participant?: Participant`                                                                                                                                                                 | Renders span containing participant name (or identity if name not available) with optional children          | `./reference-only/react/src/components/participant/ParticipantName.tsx`            |
| `ConnectionQualityIndicator` | Show individual participant connection quality                               | `participant?: Participant`                                                                                                                                                                 | Renders quality icon or custom children based on connection quality                                          | `./reference-only/react/src/components/participant/ConnectionQualityIndicator.tsx` |
| `TrackMutedIndicator`        | Show whether participant's camera/microphone is muted                        | `trackRef: TrackReferenceOrPlaceholder; show?: 'always' \| 'muted' \| 'unmuted'`                                                                                                            | Renders muted/unmuted icon based on track state and show prop                                                | `./reference-only/react/src/components/participant/TrackMutedIndicator.tsx`        |
| `AudioTrack`                 | Render participant audio tracks                                              | `trackRef?: TrackReference; onSubscriptionStatusChanged?: (subscribed: boolean) => void; volume?: number; muted?: boolean`                                                                  | Renders audio element with volume and mute controls for remote audio tracks                                  | `./reference-only/react/src/components/participant/AudioTrack.tsx`                 |
| `VideoTrack`                 | Render participant video tracks                                              | `trackRef?: TrackReference; onTrackClick?: (evt: ParticipantClickEvent) => void; onSubscriptionStatusChanged?: (subscribed: boolean) => void; manageSubscription?: boolean`                 | Renders video element with auto-subscription management based on intersection                                | `./reference-only/react/src/components/participant/VideoTrack.tsx`                 |
| `AudioVisualizer`            | Visualize audio volume as SVG bars (deprecated)                              | `trackRef?: TrackReference`                                                                                                                                                                 | Renders SVG with animated bars showing audio volume levels                                                   | `./reference-only/react/src/components/participant/AudioVisualizer.tsx`            |
| `BarVisualizer`              | Visualize audio signals as bars with voice assistant state transitions       | `state?: AgentState; barCount?: number; trackRef?: TrackReferenceOrPlaceholder; track?: TrackReferenceOrPlaceholder \| LocalAudioTrack \| RemoteAudioTrack; options?: BarVisualizerOptions` | Renders div with audio bars that animate based on volume and voice assistant state                           | `./reference-only/react/src/components/participant/BarVisualizer.tsx`              |

### Control Components

| Name                  | Purpose                                                    | Props                                                                                                                                                                                                                                                                                                                                    | Output/Behavior                                                                       | Reference                                                                |
| --------------------- | ---------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------- | ------------------------------------------------------------------------ |
| `TrackToggle`         | Toggle button for enabling/disabling camera and microphone | `source: T; showIcon?: boolean; initialState?: boolean; onChange?: (enabled: boolean, isUserInitiated: boolean) => void; captureOptions?: CaptureOptionsBySource<T>; publishOptions?: TrackPublishOptions; onDeviceError?: (error: Error) => void`                                                                                       | Renders button with track source icon that toggles track state                        | `./reference-only/react/src/components/controls/TrackToggle.tsx`         |
| `DisconnectButton`    | Button to disconnect from LiveKit room                     | `stopTracks?: boolean`                                                                                                                                                                                                                                                                                                                   | Renders button that disconnects from the room when clicked                            | `./reference-only/react/src/components/controls/DisconnectButton.tsx`    |
| `MediaDeviceSelect`   | List of media devices with selection capability            | `kind: MediaDeviceKind; onActiveDeviceChange?: (deviceId: string) => void; onDeviceListChange?: (devices: MediaDeviceInfo[]) => void; onDeviceSelectError?: (e: Error) => void; initialSelection?: string; exactMatch?: boolean; track?: LocalAudioTrack \| LocalVideoTrack; requestPermissions?: boolean; onError?: (e: Error) => void` | Renders ul list of media devices with buttons to select active device                 | `./reference-only/react/src/components/controls/MediaDeviceSelect.tsx`   |
| `ChatToggle`          | Button that toggles visibility of chat component           | none                                                                                                                                                                                                                                                                                                                                     | Renders button that toggles chat visibility when clicked                              | `./reference-only/react/src/components/controls/ChatToggle.tsx`          |
| `FocusToggle`         | Toggle for focusing/unfocusing participant tiles           | `trackRef?: TrackReferenceOrPlaceholder`                                                                                                                                                                                                                                                                                                 | Renders button with focus/unfocus icon that toggles participant focus                 | `./reference-only/react/src/components/controls/FocusToggle.tsx`         |
| `ClearPinButton`      | Clear pinned view and return to grid layout                | none                                                                                                                                                                                                                                                                                                                                     | Renders button that clears pinned view and displays grid layout                       | `./reference-only/react/src/components/controls/ClearPinButton.tsx`      |
| `SettingsMenuToggle`  | Button that toggles visibility of settings menu            | none                                                                                                                                                                                                                                                                                                                                     | Renders button that toggles settings menu visibility when clicked                     | `./reference-only/react/src/components/controls/SettingsMenuToggle.tsx`  |
| `StartAudio`          | Button to bypass browser autoplay policies for audio       | `room?: Room; label: string`                                                                                                                                                                                                                                                                                                             | Renders button to start audio playback when browser blocks autoplay                   | `./reference-only/react/src/components/controls/StartAudio.tsx`          |
| `StartMediaButton`    | Button to bypass browser autoplay policies for media       | `label?: string`                                                                                                                                                                                                                                                                                                                         | Renders button to start media playback when browser blocks autoplay                   | `./reference-only/react/src/components/controls/PaginationControl.tsx`   |
| `PaginationControl`   | Controls for navigating between pagination pages           | `totalPageCount: number; nextPage: () => void; prevPage: () => void; currentPage: number; pagesContainer?: React.RefObject<HTMLElement>`                                                                                                                                                                                                 | Renders navigation buttons and page count indicator with interaction-based visibility | `./reference-only/react/src/components/controls/PaginationControl.tsx`   |
| `PaginationIndicator` | Visual indicator showing current pagination position       | `totalPageCount: number; currentPage: number`                                                                                                                                                                                                                                                                                            | Renders div with bubble indicators showing current page position                      | `./reference-only/react/src/components/controls/PaginationIndicator.tsx` |

### UI Components

| Name                   | Purpose                                      | Props                                                                                                          | Output/Behavior                                                                                          | Reference                                                        |
| ---------------------- | -------------------------------------------- | -------------------------------------------------------------------------------------------------------------- | -------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------- |
| `ChatEntry`            | Display individual chat messages             | `entry: ReceivedChatMessage; hideName?: boolean; hideTimestamp?: boolean; messageFormatter?: MessageFormatter` | Renders li element containing participant name, timestamp, formatted message, and attached images        | `./reference-only/react/src/components/ChatEntry.tsx`            |
| `Toast`                | Display short-lived messages to the user     | none                                                                                                           | Renders div with 'lk-toast' class containing children                                                    | `./reference-only/react/src/components/Toast.tsx`                |
| `ConnectionStateToast` | Display connection state toast notifications | `room?: Room`                                                                                                  | Renders Toast component with spinner and connection state text when connecting/reconnecting/disconnected | `./reference-only/react/src/components/ConnectionStateToast.tsx` |

### Prefab Components

| Name                       | Purpose                                                                                     | Props                                                                                                                                                                                                                                                                                                                                                       | Output/Behavior                                                                                                                                                                                                                            | Reference                                                         |
| -------------------------- | ------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ | ----------------------------------------------------------------- |
| `VideoConference`          | Complete video conferencing app with grid/focus layouts, screen sharing, and chat           | `chatMessageFormatter?: MessageFormatter; chatMessageEncoder?: MessageEncoder; chatMessageDecoder?: MessageDecoder; SettingsComponent?: React.ComponentType`                                                                                                                                                                                                | Dynamic layout switching between grid and focus views, auto-focus on screen share tracks, integrates ControlBar and Chat widgets, handles track pinning, shows ConnectionStateToast, includes RoomAudioRenderer                            | `./reference-only/react/src/prefabs/VideoConference.tsx`          |
| `AudioConference`          | Default setup for classic audio conferencing app with participant grid/focus view switching | none                                                                                                                                                                                                                                                                                                                                                        | Provides audio participant tiles using TrackLoop with ParticipantAudioTile, includes ControlBar with mic/screenShare/camera/chat controls, integrates Chat widget based on state, uses LayoutContextProvider for widget state management   | `./reference-only/react/src/prefabs/AudioConference.tsx`          |
| `ControlBar`               | Media device control interface with customizable control options                            | `controls?: ControlBarControls; variation?: 'minimal' \| 'verbose' \| 'textOnly'; saveUserChoices?: boolean; onDeviceError?: (error: { source: Track.Source; error: Error }) => void`                                                                                                                                                                       | Renders control bar with mic/camera/screenShare/chat/settings/leave controls, includes MediaDeviceMenus for device selection, adapts UI based on screen space and permissions, persists user device choices, starts media if not connected | `./reference-only/react/src/prefabs/ControlBar.tsx`               |
| `Chat`                     | Real-time chat functionality for LiveKit rooms with message formatting                      | `messageFormatter?: MessageFormatter; messageEncoder?: MessageEncoder; messageDecoder?: MessageDecoder; channelTopic?: any`                                                                                                                                                                                                                                 | Renders chat interface with header, message list, and input form; handles sending/receiving messages in real-time, manages unread message counts, auto-scrolls to latest messages, supports custom message formatting                      | `./reference-only/react/src/prefabs/Chat.tsx`                     |
| `MediaDeviceMenu`          | Dropdown menu for selecting audio/video input devices                                       | `kind?: MediaDeviceKind; initialSelection?: string; onActiveDeviceChange?: (kind: MediaDeviceKind, deviceId: string) => void; tracks?: Partial<Record<MediaDeviceKind, LocalAudioTrack \| LocalVideoTrack \| undefined>>; requestPermissions?: boolean`                                                                                                     | Renders button that opens device selection menu, lists available audio/video devices, handles device switching with permission requests, computes menu position, closes menu on click outside                                              | `./reference-only/react/src/prefabs/MediaDeviceMenu.tsx`          |
| `PreJoin`                  | Pre-room join interface for selecting devices and username before entering a room           | `onSubmit?: (values: LocalUserChoices) => void; onValidate?: (values: LocalUserChoices) => boolean; onError?: (error: Error) => void; defaults?: Partial<LocalUserChoices>; debug?: boolean; joinLabel?: string; micLabel?: string; camLabel?: string; userLabel?: string; persistUserChoices?: boolean; videoProcessor?: TrackProcessor<Track.Kind.Video>` | Shows video preview with device selection, audio/video toggles with device menus, username input field, validation before submission, persists user choices, debug mode for viewing choices                                                | `./reference-only/react/src/prefabs/PreJoin.tsx`                  |
| `VoiceAssistantControlBar` | Specialized control bar for voice assistant applications with audio visualization           | `controls?: VoiceAssistantControlBarControls; saveUserChoices?: boolean; onDeviceError?: (error: { source: Track.Source; error: Error }) => void`                                                                                                                                                                                                           | Renders microphone control with BarVisualizer audio visualization, audio device menu selection, disconnect button, starts media if not connected, persists user audio choices                                                              | `./reference-only/react/src/prefabs/VoiceAssistantControlBar.tsx` |

## Functions / Utilities List

| Name                            | Purpose                                                                               | Params                                                                                   | Return                               | Reference                                                                                    |
| ------------------------------- | ------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------- | ------------------------------------ | -------------------------------------------------------------------------------------------- |
| `mergeProps`                    | Merge props objects with event chaining, class combining, id deduplication            | `...args: Props[]`                                                                       | `UnionToIntersection<TupleTypes<T>>` | `./reference-only/react/src/mergeProps.ts`                                                   |
| `chain`                         | Call all functions in order with same arguments                                       | `...callbacks: any[]`                                                                    | `(...args: any[]) => void`           | `./reference-only/react/src/mergeProps.ts`                                                   |
| `cloneSingleChild`              | Clone single child element with merged props                                          | `children: React.ReactNode \| React.ReactNode[]; props?: Record<string, any>; key?: any` | `React.ReactNode`                    | `./reference-only/react/src/utils.ts`                                                        |
| `warnAboutMissingStyles`        | Warn if @livekit/components-styles is not imported                                    | `el?: HTMLElement`                                                                       | `void`                               | `./reference-only/react/src/utils.ts`                                                        |
| `roomOptionsStringifyReplacer`  | Stringify room options for dependency detection, replaces processors and e2ee options | `key: string; val: unknown`                                                              | `unknown`                            | `./reference-only/react/src/utils.ts`                                                        |
| `useBarAnimator`                | Create animated bar visualizations based on agent state                               | `state: AgentState \| undefined; columns: number; interval: number`                      | `number[]`                           | `./reference-only/react/src/components/participant/animators/useBarAnimator.ts`              |
| `generateConnectingSequenceBar` | Create bar animation sequence for connecting state                                    | `step: number`                                                                           | `number`                             | `./reference-only/react/src/components/participant/animationSequences/connectingSequence.ts` |
| `generateListeningSequenceBar`  | Create bar animation sequence for listening state                                     | `step: number`                                                                           | `number`                             | `./reference-only/react/src/components/participant/animationSequences/listeningSequence.ts`  |
| `generateThinkingSequenceBar`   | Create bar animation sequence for thinking state                                      | `step: number`                                                                           | `number`                             | `./reference-only/react/src/components/participant/animationSequences/thinkingSequence.ts`   |
| `formatChatMessageLinks`        | Format links in chat messages                                                         | `message: string`                                                                        | `string`                             | `./reference-only/react/src/components/ChatEntry.tsx`                                        |

## Contexts List

| Name                 | Purpose                                           | Exports                                                                                                                                                               | Reference                                                       |
| -------------------- | ------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------- |
| `RoomContext`        | Provides Room instance to child components        | `RoomContext`, `useRoomContext`, `useMaybeRoomContext`, `useEnsureRoom`                                                                                               | `./reference-only/react/src/context/room-context.ts`            |
| `ParticipantContext` | Provides Participant instance to child components | `ParticipantContext`, `useParticipantContext`, `useMaybeParticipantContext`, `useEnsureParticipant`                                                                   | `./reference-only/react/src/context/participant-context.ts`     |
| `TrackRefContext`    | Provides TrackReference to child components       | `TrackRefContext`, `useTrackRefContext`, `useMaybeTrackRefContext`, `useEnsureTrackRef`                                                                               | `./reference-only/react/src/context/track-reference-context.ts` |
| `LayoutContext`      | Manages layout state (pinning, widgets)           | `LayoutContext`, `LayoutContextType`, `useLayoutContext`, `useMaybeLayoutContext`, `useCreateLayoutContext`, `useEnsureCreateLayoutContext`, `useEnsureLayoutContext` | `./reference-only/react/src/context/layout-context.ts`          |
| `ChatContext`        | Manages chat widget state                         | `WidgetContextType`, `ChatContextAction`, `chatReducer`                                                                                                               | `./reference-only/react/src/context/chat-context.ts`            |
| `PinContext`         | Manages pinned tracks state                       | `PinContextType`, `PinAction`, `pinReducer`                                                                                                                           | `./reference-only/react/src/context/pin-context.ts`             |
| `SessionContext`     | Manages agent session state                       | `SessionContext`, `useSessionContext`, `useMaybeSessionContext`, `useEnsureSession`                                                                                   | `./reference-only/react/src/context/session-context.ts`         |
| `LKFeatureContext`   | Manages feature flags                             | `FeatureFlags`, `LKFeatureContext`, `useFeatureContext`                                                                                                               | `./reference-only/react/src/context/feature-context.ts`         |

## Implementation Rules

1. Implement **one component / hook / function at a time**
2. Before implementing:
   - Open the corresponding file in `./reference-only/react`
3. After implementation:
   - Verify API and behavior match exactly
   - Run `bunx @sveltejs/mcp svelte-autofixer <file.svelte>`
4. No implementation without a reference file
5. Maintain exact folder structure from `./reference-only/react`
6. All exports must match React implementation

## TypeScript Rules

- `strict: true`
- No `any`
- No unsafe type assertions
- Full end-to-end type safety
- DRY principle
- No dead code
- No circular dependencies
- `eslint-disable` is forbidden

## Absolute Constraints

- No API differences
- No renamed params
- No reordered params
- No added or removed features
- No deprecated APIs
- 100% API parity with React implementation
